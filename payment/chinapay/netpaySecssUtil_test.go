package chinapay

import (
	"encoding/hex"
	"testing"

	. "github.com/smartystreets/goconvey/convey"
)

var secss *NetPaySecssUtil

func Test_NetPaySecssUtil(t *testing.T) {
	signKey, _ := hex.DecodeString(`30820ae602010330820aa206092a864886f70d010701a0820a9304820a8f30820a8b3082060c06092a864886f70d010701a08205fd048205f9308205f5308205f1060b2a864886f70d010c0a0102a08204fe308204fa301c060a2a864886f70d010c0103300e040887489f52eda0bb9b020207d0048204d8053eb733cff722d077f323c8d8703736d884a1960a9524805ff2e8834687e39bb0df76524bc67818dd65b71dc3126a1f37ca82dc91a811a98d625c19d87d3948735096d2179980fe8946495c8a87cb55c61e727b6550403d3692786bb19f093a28b4cbcbdcb162ca06933e417e9960c1a4e69c6a09683584caf7151de815bf84336a00681ef7c60ee13bf5a54c2c19332ce67808cd45d31ba5b82636369c527119390bd75ba90527a8f0c1fa92e3a8ca0050a309453c170bcfe5305c04695acd7acfd2ddafd5a560f7109165ada7d12f025cfb344075a00a23fb32e426a7ef38d9ef148501ad4c61ede978d3e2bbfc49fe932449dad323d5ae25133c2f0e85e35ad71a25d27d791ab35764c1ff6726454873e7925cd6a5c4aa41b907155b224d1a028c0c7e803751f703d0b5f810e7a6eb2c1d1f6bfd9d53fa5f208a050057fc2e4999305d9e8f8e5fd58f1e65519f5d545b513a9497bdea671b8353d4a4e8a213c5e9337ddaed6e58faab18d57398cf0a297e75f3be4045ab47f00f9e1ef2dbf635c4a76c46895cd8a79eee11db4d9e324c00b59bb7f48b20848a5c9f64730be8b1b1905e0b4c0ccffbdec92d29b3ab260444bd563851d7e9cbba0426618e726966d12c28b2f46d75434d0d2ff0dbb4d780dda85bac8bb55083f8d5711e1250bfe111059f30bb214f7f1f3c7bb286e3b54e57fcd5f9bfeac3a88b8c844c54db20cc6b93ac48a9afeea4bc9fce4477405d26fad5bddfcb128c2581bfb115545fc51aca16c11ac4077c9fc801e89a84ba5051ac084e6cf01d9a429c6e962c87cd8ee2e78bf2dec56c9e4052c86c46c5d5e8b42732a728ed13963bd786dd7b417a6c0b3acb05dc1f8bb2023f5d21a36e0d9975f2f7a44eba67eea071a84c53c9a812c4f1a793257e53c2fa7dc7adc4c4515592a3d180b1bfc56efdd212fa2ebdfa4b318598962d512e9f4306bd2a708fbe018c1730da2d8dd0b38d80a5b286893d72261b44a9f36eb2b87498c30b0ab87da2c88e88b238b33589b86290aa80e69242de06fb29e4bac537059cbf2f538eed3ec2904376ec5ad8b20dbd8819c236a55947015febd21a9755a82f7cebf4472867df5e8319f271cf56028770117bc06dbd2b4f41a934cb2515990cdefbc3f69eba750551dad2703fbfff97184088d441226975d01ac34cd5347f36f6b121191be69f58cc16909069a8acecdd7da0e22a6f2f7fb6d02132d270a10f2b941ae8c8635d1a0615fc22397f054142233a063499c5baf7e9467a1e6c6157c8190a819f786b29c2ae3f0a6693a0c59bf6ae5cb73fc1ac15f716a57df21b739464aa9b9879d6353c5bee9ffd71daf79e13e713987532d53901244c58865aba632d77c9a80e6ded3fc1e47d556bdd0c2d69ad9d038c0013bd8b89f84f4cdeecea15f99dc95f8381cf122f56d4826ec4b3022c18968d2166a35c9b3b00959ae93ed4b5fc190b68cc40c891245027e8c23a58066da54381011a56b58bb0e26756f664febfcfc7a812e54b2f525e8db509ec3cf0b162db95cb8af39520a4214c3e644ff9447fac3e777b869dfed4b9134b738742c82651ef0e10d7b3dbd07666008f4b7fcac45aff8f46827308506432361c0cb13893c40845920ba8714e69efe3458e48026cae26c03ae14cc532d2b785189af1511e9f208a2cf9a6f6c16a78ac71aff865ac40c75abc2d9aef6b67da380e688182734bb240b6629e20c48067bcb8fe12722e0dcb147b0a8279353181df301306092a864886f70d0109153106040401000000305b06092a864886f70d010914314e1e4c007b00360042003200440046003900460035002d0032003600390037002d0034004100320036002d0041003300330039002d003600340043003400340046003900350031003500380033007d306b06092b0601040182371101315e1e5c004d006900630072006f0073006f0066007400200045006e00680061006e006300650064002000430072007900700074006f0067007200610070006800690063002000500072006f00760069006400650072002000760031002e00303082047706092a864886f70d010706a0820468308204640201003082045d06092a864886f70d010701301c060a2a864886f70d010c0106300e040891ed2279f57702d3020207d0808204309da03dda1a8df52bec73b7af5578c8761bc3b05fb43fae3e4625ffe5d7d414686f7c7b586b5d02e633b16b9494e810e2fcc4f7595c3d3ae33ce36f8a075a9a5028123a7e258a727d9ccf82ceb7c5fda4705fa6ef68055ea575fb7abee147bb8dd60befa3e5d982e5690175a3a5b3e8745550133c94ad36e33e1b2b96131676f623edda00ee9a556b8c1222204c2c8ebf166762569e87111eca613d2789df846f5604f689850112284498ea097f69e7a2895a2304a2320fc610d88932f9bfeb1cfcf75c099ad6c92a798666a50748b9d4c5bc5cd3189d6e21f3b4a2582aeb3fb4768870c272abd1ea4aa37acf9fdecf4608ae4fc2425792b2be5615bc1b0919b6580d25f53729b4e066305e9ed19cdc08b435eefa261e98af5849d376663c04631f028005e1f16cb859e53d57c528c922f4cb7c3e46805bd209227cc8a362c6365807e4a4563c98d295e5866f03c85f956d1d0aff47bf592de7485a9d27ec789ecf950f8ac58f7c25cfbcf0891e3e8d746fd02efc1f57af7d137807b90e74c48a646e7c640d6908a6d35e9c8611dff8de67cd4f4ea460b4a5c83ac8a517ab04e029e289a8d59f0db155c4d7b838a8d696c4d600ceaef7d69312689380c257a7ec10a7cf80d6aa228158afe20bd3459ebffc5b43b6f29a3e88880b90ad1203cfc7ee1fe6fe1db0ec8a9b66e9e2384abfa3bb19105ecfb4d84686529949fe149fbde1081f3582742c409ce8cf8b4408378b6b0f6f56c6e6515cad1e27e0ced24b21054deff097d6a15cd6ecee035fc037f2a0df8fbe7ca0d245500b9bbe90337b45c9f59ba2ff4bf4e6f7b2b0b0a7b1fb5acc91cee906092ff1c1735e50f29900fc4c17af3c7b98e80de8e632a80b097c3a9ec8ee07ac8e5c40899367f2351aa4c87695e2271dce300db0b16270ce1e22bc640773b740e00fc1a754d0a69a65d863ab0e368f5c277b567e33b13f00d064dcec297ff378460c7a9a08dad5f2bb856c0fcc0621343127eceb09e88482f48cf3b0c104e29a0b47e2f625e8e3584c0fc2b13fa463c157f98164a6b5f649dc1edbaacbfcd8b6ec12cdc0ea966a9ca1dc8cfa824c14339e1f6b7164eb7eafdcae3e52f4475bacaaf2226bf040c0e514f2aa7e6afb3138f52cf07687008af4eb8ec7da97ddf5c453c5f3fe7007b11909366595e1ee4328de33015ecd5cb214f273bbe0eed5335ddc101db7251503a79829ecddde9b5bd6a416c1b2db3ea6d1a39359a3f7c3a931f37a0f8681806c78fdadbe5cc9e91cd4d0fdd0b1636153d81bdff342528af1dee0f40d006dcd67c2fc0a9c206737abe0f60b5dd8086de4cb4e10f5d043c6c2a1cce23fcd8cb05e3e59724a689e860d71eae4f2ee8d9dfc1c7f2d5fb668b3f2641c5b540146ae04575e3d7476c426d53419403a80ede78970b19478f3b79d2fb54eb7131578f1d04789cecad6962cb51e9592564038430db7e52679b961e2f2bfed46169614e3b2917daade1443944f5e9b86ab4407a1bad8bd8d3b303b301f300706052b0e03021a0414d9a4408db0f17f1b8e73770bf58d47df252d31570414867ffa8c53a4d0b762a0fb9b7701ceed8fd42661020207d0`)
	verifyKey := `-----BEGIN CERTIFICATE-----
MIIDmDCCAwGgAwIBAgIQMvroCPEc4E82oFDXQnSytTANBgkqhkiG9w0BAQUFADAq
MQswCQYDVQQGEwJDTjEbMBkGA1UEChMSQ0ZDQSBPcGVyYXRpb24gQ0EyMB4XDTE2
MTAyNjA1NTE1NFoXDTE5MTAyNjA1NTE1NFowgYsxCzAJBgNVBAYTAkNOMRswGQYD
VQQKExJDRkNBIE9wZXJhdGlvbiBDQTIxETAPBgNVBAsTCENISU5BUEFZMRswGQYD
VQQLExJCdXNpbmVzcyBDdXN0b21lcnMxLzAtBgNVBAMUJjA0MUBaMzEwMTA1MTM0
NjI4OTFYQENISU5BUEFZQDAwMDAwMDAyMIGfMA0GCSqGSIb3DQEBAQUAA4GNADCB
iQKBgQCpoRxAdf2y/wB5+91uCzCPIX3OUrIol8zgDaTodgbE5mLPRnI+J2TDl3zm
WoZk6f7L5CQd8XTm6pSJUD8kybhXcaR1EWZyDPczLQd8FVi+koQFxyQ8V132Ds0r
Y9x25wyhI0l0FbLcxUqEBejUt6tP4uXnBjjMgxV+qfN2EnGv4wIDAQABo4IBWzCC
AVcwHwYDVR0jBBgwFoAU8I3ts0G7++8IHlUCwzE37zwUTs0wHQYDVR0OBBYEFDQY
fC9xvZZY/gAwqItEAP+IQlsQMAsGA1UdDwQEAwIHgDAMBgNVHRMEBTADAQEAMIH5
BgNVHR8EgfEwge4wVKBSoFCkTjBMMQswCQYDVQQGEwJDTjEbMBkGA1UEChMSQ0ZD
QSBPcGVyYXRpb24gQ0EyMQwwCgYDVQQLEwNDUkwxEjAQBgNVBAMTCWNybDEwM183
MTCBlaCBkqCBj4aBjGxkYXA6Ly9jZXJ0ODYzLmNmY2EuY29tLmNuOjM4OS9DTj1j
cmwxMDNfNzEsT1U9Q1JMLE89Q0ZDQSBPcGVyYXRpb24gQ0EyLEM9Q04/Y2VydGlm
aWNhdGVSZXZvY2F0aW9uTGlzdD9iYXNlP29iamVjdGNsYXNzPWNSTERpc3RyaWJ1
dGlvblBvaW50MA0GCSqGSIb3DQEBBQUAA4GBAFhKLBl0PZ2JFF0iONe1HTJbI6Rj
Al8jwICqyoYMnEMxPHOQgKNYukv2XEn3FT0HSy49zE1Ci9Oa/E9n8Uy93OMw458W
X3o6kF7BwJYv/0mWAy8o2Zn3wekofhu+iCVMn/5puuLuYzumQ3nqGEs5WFGvuZH5
HcFfCC934zwf48i3
-----END CERTIFICATE-----`
	secss = &NetPaySecssUtil{}
	Convey("银联NetPaySecssUtil工具测试", t, func() {
		Convey("初始化控件", func() {
			err := secss.Init(string(signKey), "zhifangw", verifyKey, "Signature,CertId", "Signature")
			So(err, ShouldBeEmpty)
			Convey("签名测试", func() {
				ret, _ := secss.Sign(map[string]string{"reqData": "50a47df2d0c8af62864aa821362b268dfa822a84c932617eaecb49dedceaac49ad7aa530a498416677644acef01d3fbe7de3f159c2bf4cc178530d590a6d3f4f"})
				So(ret, ShouldEqual, "qFJ5i5cFu5dtO2u6t24ekQSfJXDC5p3juqtu68+IuhoV1is5D3DBibupFW3076ilGG7gIEjhfrA52mbDKWpq//7waM3eMV2VQTAA9r2ts9i54db+r7h7FKDwjTJfOnKYqJxQiCUOon/uKbzisuM6gOmiCoyCia1jdS2vnt/u2z/Ha+5bpRDOgpWswiHMOexs0VGIVFS2GrOegW6mXeSx5l977Xlwl27rV/6fN4eg92F0cVxuAUJoFs5ZBOVlpG1BYh1tiUwisYa5IbDhlxp7X7pniVw1alChoBbOUB3X0tXntFYi+qw/cvPaI9TLMkpRCtTiZvutSm0CuDQlaHJ4dw==")
			})
			Convey("验签测试", func() {
				ret, _ := secss.Verify(map[string]string{
					"respData":  "34cac94faa30c6d44732fc4fbbb6e09ece269eaecc0929956a253a2a2764dbe33660719bf3d548d80e920c79d70c6c858172287169b5650d0d4dcfad9f8bca11",
					"signature": "Bo6DzOrUjXS8Eoiws04WVoL7l4A2S4aTtNKDJNCD2cletZqSnG8uJqlbyo/6uZ9wO3av21tzLsm3CaQuQyUz4BnYZLiaoKbvj9RGAl5/POnCbkpFSX6ZUcojQDDEx1UqFWfoQLF7U9QH9WTaZT795ky3xOG8/vfAi1zL+V17dnE=",
				}, "signature")
				So(ret, ShouldBeTrue)
			})
			Convey("加密测试", func() {
				ret, _ := secss.EncryptData(`{"certNo":"330782199110206617","cardNo":"6222021208007333758"}`)
				So(ret, ShouldEqual, "i92VTiMVffOucEXbYSDea6Q/04fcHeSBTzyRUlGX0qCC8HTPC42PwHhTHGat6MCrRYMlf/M27YqEgWshv0KwHWLx7gIbL6nRCyWeZeEfhIAxVnbWP0LbiF+KSmoEhvubhxKLl1q+h4kxpc3rnvaYVnKbyZwoeQB8Y1W0DwJBI+o=")
			})
			Convey("解密测试", func() {
				ret, _ := secss.DecryptData("ErYpwrVhNvSWSciHhjnNMwlTj7aGMxHMqCnURi+IFfLRMYm3KHRP8s1yY2W5dltEuvmCC9n2J0nuIGl2PHVr4sOcAL0arvWk/FMhwm2ZFjT1ybKcDS6SKcUI4co+XtDS+edJ3Ziwgqg3TNrGTEiU99o1PJ5fgPwM9KrDnaZvrif5MbwzZb+cYLsHkx/HNAr7doipfWkoQe2l9GdXOl4KMmglYQ1Usc2UxQoDq2uWBTHVLIA33oxM2m1si8p4ZSiN3DE/tw4DDquHNnyCtyHtLqUv/HA7miSbIECS5CTRetrQ/hMq6gE21NW89S1lOY7uP6YYbx7Vw4YQiPNxLytkcg==")
				So(ret, ShouldEqual, `{"cardNo":"6222021208007333758","certNo":"330782199110206617"}`)
			})
		})
	})
}
